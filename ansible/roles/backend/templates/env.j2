---
# ansible/roles/backend/templates/env.j2
NODE_ENV={{ env }}
PORT=3000
MONGO_URI={% if env == 'prod' %}mongodb://admin:{{ mongodb_password }}@{{ mongodb_host }}:27017/mernapp{% elif env == 'staging' %}mongodb://admin:{{ mongodb_password }}@{{ mongodb_host }}:27017/mernapp-staging{% else %}mongodb://admin:{{ mongodb_password }}@{{ mongodb_host }}:27017/mernapp-dev{% endif %}
JWT_SECRET={{ jwt_secret | default('your-default-jwt-secret') }}
JWT_EXPIRE=30d
CORS_ORIGIN={% if env == 'prod' %}https://yourdomain.com{% elif env == 'staging' %}https://staging.yourdomain.com{% else %}http://localhost:3000{% endif %}

---
# ansible/roles/backend/templates/ecosystem.config.js.j2
module.exports = {
  apps: [{
    name: 'mern-backend',
    script: '{{ app_dir }}/server.js',
    instances: 'max',
    exec_mode: 'cluster',
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: '{{ env }}',
      PORT: 3000
    },
    env_file: '.env.{{ env }}'
  }]
};

---
# ansible/roles/backend/templates/mern-backend.service.j2
[Unit]
Description=MERN Stack Backend Service
After=network.target

[Service]
Type=forking
User=ubuntu
WorkingDirectory={{ app_dir }}
ExecStart=/usr/local/bin/pm2 start ecosystem.config.js
ExecReload=/usr/local/bin/pm2 reload ecosystem.config.js
ExecStop=/usr/local/bin/pm2 stop ecosystem.config.js
Restart=on-failure

[Install]
WantedBy=multi-user.target